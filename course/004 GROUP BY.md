
### 4 // GROUP BY — кто сколько раз сказал «О боже, они убили Кенни!»

![image](https://static.wikia.nocookie.net/southpark/images/6/65/Kenny_death.png)

Когда данных много, иногда хочется не просто посмотреть на все строки,
а объединить их в группы и посчитать что-то внутри каждой группы.

#### Пример
Допустим, у нас есть таблица `phrases`, где сохраняется:
- персонаж (`character`)
- эпизод (`episode`)
- текст фразы (`text`)

Мы хотим узнать, кто чаще всех говорит «О боже, они убили Кенни!»:

```sql
SELECT character, COUNT(*) AS cnt
FROM phrases
WHERE text = 'О боже, они убили Кенни!'
GROUP BY character
ORDER BY cnt DESC;
```

Результат:

| character | cnt |
|-----------|-----|
| Стэн      | 15  |
| Кайл      | 14  |
| Картман   | 3   |

---
#### 10 тренировочных задач

1. Посчитать, сколько реплик произнёс каждый персонаж.
2. Найти топ-3 персонажей по количеству фраз.
3. Подсчитать, в скольких эпизодах появлялся каждый персонаж.
4. Посчитать среднее количество реплик на персонажа в каждом эпизоде.
5. Вывести персонажа с максимальным числом реплик.
6. Найти число уникальных эпизодов для каждого персонажа.
7. Подсчитать количество слов в репликах каждого персонажа.
8. Посчитать, сколько раз каждый персонаж говорил «друзья».
9. Найти персонажей, у которых больше 100 фраз.
10. Сгруппировать персонажей по первой букве имени и посчитать их количество.

---
**Ответы:**

1.
```sql
SELECT character, COUNT(*) FROM phrases GROUP BY character;
```
2.
```sql
SELECT character, COUNT(*) as cnt FROM phrases GROUP BY character ORDER BY cnt DESC LIMIT 3;
```
...и так далее.


---

## Подробно о том, что мы только что изучили

Здесь важно не просто запомнить синтаксис, а понять **почему** и **как** это работает.

- Сначала SQL выбирает строки из таблицы (FROM + WHERE).
- Потом, если есть GROUP BY, данные объединяются в группы.
- Для каждой группы можно посчитать агрегаты: COUNT (количество), SUM (сумма), AVG (среднее), MIN, MAX.
- HAVING используется, если нужно фильтровать эти группы уже после подсчётов.
- ORDER BY сортирует результат, а LIMIT отрезает хвост.
- Подзапросы — это способ встроить один запрос в другой (как матрёшка).
- CASE WHEN — маленький if/else прямо в SQL.
- Оконные функции позволяют не только видеть текущую строку, но и «соседние» строки (контекст).
- UNION объединяет результаты из разных таблиц.

### Советы
1. Не бойтесь писать длинные запросы. SQL читается сверху вниз, шаг за шагом.
2. Придумывайте себе маленькие задачи, как мы сделали в конце каждой главы.
3. Когда сомневаетесь — добавляйте ORDER BY, чтобы увидеть структуру данных.
4. Для экспериментов отлично подходит https://sqliteonline.com/

---

## Дополнительный пример из Южного Парка

Предположим, у нас есть таблица `troublemakers` (нарушители порядка) со столбцами:
- `character`
- `episode`
- `incident` (например, «сломал автобус», «поссорился с Кайлом»)

**Задача:** посчитать, сколько инцидентов было у каждого персонажа и вывести только тех, у кого больше 2.

```sql
SELECT character, COUNT(*) AS incidents
FROM troublemakers
GROUP BY character
HAVING COUNT(*) > 2
ORDER BY incidents DESC;
```

Видим, что на первых местах окажутся Картман и Баттерс.

---

Теперь попробуй сам на примере таблицы `phrases`, придумывая свои критерии!
